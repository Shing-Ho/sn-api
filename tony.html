<!doctype html>
<head>
	<title>Mongo Schema</title>

	<style>
		svg {
			background-color: white;
			font-family: "Helvetic Neue", Helvetica, Arial, sans-serif;
			font-size: small;
		}

		.node rect,
		.node circle,
		.node ellipse {
		  stroke: #333;
		  opacity: 0.8;
		  fill: #fff;
		  fill-opacity: 0.6;
		}
		.edgePath path {
		  stroke: #333;
		  fill: #333;
		  fill-opacity: 1;
		  stroke-opacity: 1;
		}
		.cluster {
		  stroke: #999;
		  fill: #888;
		  fill-opacity: 0.3;
		  stroke-opacity: 0.6;
		}
		.entity-name rect {
		  fill: #08f;
		  fill-opacity: 0.3;
		}
	</style>
</head>

<body>
	<div class="background"></div>
	<div class="container">
		<svg></svg>
	</div>
	<canvas width="1024" height="1024" style="display:none"></canvas>


	<script src="https://d3js.org/d3.v3.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/dagre-d3/0.4.17/dagre-d3.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>

	<script>
		var drawERM = function(data) {
			var width = window.innerWidth, 
			initialHeight = window.innerHeight, 
			svg = d3.select("body div.container svg"),
			inner = svg.append("g");

			svg.attr('width', width).attr('height', initialHeight);

			var resizeGraph = function(doCenter) {
				var newWidth = window.innerWidth; 
				var newHeight = window.innerHeight;

				if(newWidth < g.graph().width + 40) {
					newWidth = g.graph().width + 40;
				}
				if(newHeight < g.graph().height + 40) {
					newHeight = g.graph().height + 40;
				}
				svg.attr('width', newWidth).attr('height', newHeight);

				// Center the graph
				if(doCenter) {
					zoom
					  .translate([(svg.attr("width") - g.graph().width * initialScale) / 2, 20])
					  .scale(initialScale)
					  .event(svg);
				}
			}

			// Set up zoom support
			var zoom = d3.behavior.zoom().on("zoom", function() {
			  inner.attr("transform", "translate(" + d3.event.translate + ")" +
			    "scale(" + d3.event.scale + ")");
			});
			svg.call(zoom);

			// create graph
			var g = new dagreD3.graphlib.Graph({
			  multigraph: false,
			  compound: true
			}).setGraph({
			  rankdir: "LR",
			  edgesep: 25,
			  nodesep: 0
			});

			var links = [];

			var addField = function(collectionName, fieldName, fieldInfo, parentFieldName) {
				var nodeName = parentFieldName ? collectionName + "_" + parentFieldName + "_" + fieldName : collectionName + "_" + fieldName;
				g.setNode(nodeName, {
				  label: (parentFieldName ? parentFieldName + "." + fieldName : fieldName) + ": " + fieldInfo.type,
				  width: 300
				});
				g.setParent(nodeName, "___" + collectionName + "_container");

				if(fieldInfo.foreignKey && fieldInfo.references) {
					links.push({
						from: nodeName,
						to: fieldInfo.references + "__id"
					});			
				}

				if(fieldInfo.type == "Object" && fieldInfo.structure) {
					for(var subFieldName in fieldInfo.structure) {
						addField(collectionName, subFieldName, fieldInfo.structure[subFieldName], parentFieldName ? parentFieldName + "." + fieldName : fieldName);
					}
				}
			};

			var addCollection = function(collectionName, collectionInfo) {
				g.setNode("___" + collectionName + "_container", {
				  label: ""
				});
				g.setNode("___" + collectionName + "_title", {
				  label: collectionName,
				  class: 'entity-name',
				  labelStyle: 'font-weight:bold;',
				  width: 300
				});

				g.setParent("___" + collectionName + "_title", "___" + collectionName + "_container");

				for(var fieldName in collectionInfo) {
					addField(collectionName, fieldName, collectionInfo[fieldName]);
				}
			};

			for(var collectionName in data) {
				addCollection(collectionName, data[collectionName]);
			}

			links.map(function(link) {
				g.setEdge(link.from, link.to, {
				  label: '',
				  lineInterpolate: 'monotone'
				});
			});

			// Create the renderer
			var render = dagreD3.render();

			// Run the renderer. This is what draws the final graph.
			render(inner, g);

			// adjust height
			var initialScale = 1; //0.75;

			window.addEventListener('resize', function () {
				resizeGraph();
			});

			resizeGraph(true);

		};

		var data = {
	"NFL_PLAYER_STATS": {
		"_id": {
			"primaryKey": true,
			"type": "Object",
			"required": true
		},
		"bookit_game_id": {
			"type": "string",
			"required": true
		},
		"game_key": {
			"type": "string",
			"required": true
		},
		"player_id": {
			"type": "number",
			"required": true
		},
		"season_type": {
			"type": "number",
			"required": true
		},
		"season": {
			"type": "number",
			"required": true
		},
		"game_date": {
			"type": "string",
			"required": true
		},
		"week": {
			"type": "number",
			"required": true
		},
		"team": {
			"type": "string",
			"required": true
		},
		"opponent": {
			"type": "string",
			"required": true
		},
		"home_or_away": {
			"type": "string",
			"required": true
		},
		"number": {
			"type": "number",
			"required": true
		},
		"name": {
			"key": true,
			"type": "string",
			"required": true
		},
		"position": {
			"type": "string",
			"required": true
		},
		"position_category": {
			"type": "string",
			"required": true
		},
		"activated": {
			"type": "number",
			"required": true
		},
		"played": {
			"type": "number",
			"required": true
		},
		"started": {
			"type": "number",
			"required": true
		},
		"passing_attempts": {
			"type": "number",
			"required": true
		},
		"passing_completions": {
			"type": "number",
			"required": true
		},
		"passing_yards": {
			"type": "number",
			"required": true
		},
		"passing_completion_percentage": {
			"type": "number",
			"required": true
		},
		"passing_yards_per_attempt": {
			"type": "number",
			"required": true
		},
		"passing_yards_per_completion": {
			"type": "number",
			"required": true
		},
		"passing_touchdowns": {
			"type": "number",
			"required": true
		},
		"passing_interceptions": {
			"type": "number",
			"required": true
		},
		"passing_rating": {
			"type": "number",
			"required": true
		},
		"passing_long": {
			"type": "number",
			"required": true
		},
		"passing_sacks": {
			"type": "number",
			"required": true
		},
		"passing_sack_yards": {
			"type": "number",
			"required": true
		},
		"rushing_attempts": {
			"type": "number",
			"required": true
		},
		"rushing_yards": {
			"type": "number",
			"required": true
		},
		"rushing_yards_per_attempt": {
			"type": "number",
			"required": true
		},
		"rushing_touchdowns": {
			"type": "number",
			"required": true
		},
		"rushing_long": {
			"type": "number",
			"required": true
		},
		"receiving_targets": {
			"type": "number",
			"required": true
		},
		"receptions": {
			"type": "number",
			"required": true
		},
		"receiving_yards": {
			"type": "number",
			"required": true
		},
		"receiving_yards_per_reception": {
			"type": "number",
			"required": true
		},
		"receiving_touchdowns": {
			"type": "number",
			"required": true
		},
		"receiving_long": {
			"type": "number",
			"required": true
		},
		"fumbles": {
			"type": "number",
			"required": true
		},
		"fumbles_lost": {
			"type": "number",
			"required": true
		},
		"punt_returns": {
			"type": "number",
			"required": true
		},
		"punt_return_yards": {
			"type": "number",
			"required": true
		},
		"punt_return_yards__per_attempt": {
			"type": "number",
			"required": true
		},
		"punt_return_touchdowns": {
			"type": "number",
			"required": true
		},
		"punt_return_long": {
			"type": "number",
			"required": true
		},
		"kick_returns": {
			"type": "number",
			"required": true
		},
		"kick_return_yards": {
			"type": "number",
			"required": true
		},
		"kick_return_yards__per_attempt": {
			"type": "number",
			"required": true
		},
		"kick_return_touchdowns": {
			"type": "number",
			"required": true
		},
		"kick_return_long": {
			"type": "number",
			"required": true
		},
		"solo_tackles": {
			"type": "number",
			"required": true
		},
		"assisted_tackles": {
			"type": "number",
			"required": true
		},
		"tackles_for_loss": {
			"type": "number",
			"required": true
		},
		"sacks": {
			"type": "number",
			"required": true
		},
		"sack_yards": {
			"type": "number",
			"required": true
		},
		"quarterback_hits": {
			"type": "number",
			"required": true
		},
		"passes_defended": {
			"type": "number",
			"required": true
		},
		"fumbles_forced": {
			"type": "number",
			"required": true
		},
		"fumbles_recovered": {
			"type": "number",
			"required": true
		},
		"fumble_return_yards": {
			"type": "number",
			"required": true
		},
		"fumble_return_touchdowns": {
			"type": "number",
			"required": true
		},
		"interceptions": {
			"type": "number",
			"required": true
		},
		"interception_return_yards": {
			"type": "number",
			"required": true
		},
		"interception_return_touchdowns": {
			"type": "number",
			"required": true
		},
		"blocked_kicks": {
			"type": "number",
			"required": true
		},
		"special_teams_solo_tackles": {
			"type": "number",
			"required": true
		},
		"special_teams_assisted_tackles": {
			"type": "number",
			"required": true
		},
		"misc_solo_tackles": {
			"type": "number",
			"required": true
		},
		"misc_assisted_tackles": {
			"type": "number",
			"required": true
		},
		"punts": {
			"type": "number",
			"required": true
		},
		"punt_yards": {
			"type": "number",
			"required": true
		},
		"punt_average": {
			"type": "number",
			"required": true
		},
		"field_goals_attempted": {
			"type": "number",
			"required": true
		},
		"field_goals_made": {
			"type": "number",
			"required": true
		},
		"field_goals_longest_made": {
			"type": "number",
			"required": true
		},
		"extra_points_made": {
			"type": "number",
			"required": true
		},
		"two_point_conversion_passes": {
			"type": "number",
			"required": true
		},
		"two_point_conversion_runs": {
			"type": "number",
			"required": true
		},
		"two_point_conversion_receptions": {
			"type": "number",
			"required": true
		},
		"fantasy_points": {
			"type": "number",
			"required": true
		},
		"fantasy_points_pp_r": {
			"type": "number",
			"required": true
		},
		"reception_percentage": {
			"type": "number",
			"required": true
		},
		"receiving_yards_per_target": {
			"type": "number",
			"required": true
		},
		"tackles": {
			"type": "number",
			"required": true
		},
		"offensive_touchdowns": {
			"type": "number",
			"required": true
		},
		"defensive_touchdowns": {
			"type": "number",
			"required": true
		},
		"special_teams_touchdowns": {
			"type": "number",
			"required": true
		},
		"touchdowns": {
			"type": "number",
			"required": true
		},
		"fantasy_position": {
			"type": "string",
			"required": true
		},
		"field_goal_percentage": {
			"type": "number",
			"required": true
		},
		"player_game_id": {
			"type": "number",
			"required": true
		},
		"fumbles_own_recoveries": {
			"type": "number",
			"required": true
		},
		"fumbles_out_of_bounds": {
			"type": "number",
			"required": true
		},
		"kick_return_fair_catches": {
			"type": "number",
			"required": true
		},
		"punt_return_fair_catches": {
			"type": "number",
			"required": true
		},
		"punt_touchbacks": {
			"type": "number",
			"required": true
		},
		"punt_inside20": {
			"type": "number",
			"required": true
		},
		"punt_net_average": {
			"type": "number",
			"required": true
		},
		"extra_points_attempted": {
			"type": "number",
			"required": true
		},
		"blocked_kick_return_touchdowns": {
			"type": "number",
			"required": true
		},
		"field_goal_return_touchdowns": {
			"type": "number",
			"required": true
		},
		"safeties": {
			"type": "number",
			"required": true
		},
		"field_goals_had_blocked": {
			"type": "number",
			"required": true
		},
		"punts_had_blocked": {
			"type": "number",
			"required": true
		},
		"extra_points_had_blocked": {
			"type": "number",
			"required": true
		},
		"punt_long": {
			"type": "number",
			"required": true
		},
		"blocked_kick_return_yards": {
			"type": "number",
			"required": true
		},
		"field_goal_return_yards": {
			"type": "number",
			"required": true
		},
		"punt_net_yards": {
			"type": "number",
			"required": true
		},
		"special_teams_fumbles_forced": {
			"type": "number",
			"required": true
		},
		"special_teams_fumbles_recovered": {
			"type": "number",
			"required": true
		},
		"misc_fumbles_forced": {
			"type": "number",
			"required": true
		},
		"misc_fumbles_recovered": {
			"type": "number",
			"required": true
		},
		"short_name": {
			"key": true,
			"type": "string",
			"required": true
		},
		"playing_surface": {
			"type": "string",
			"required": true
		},
		"is_game_over": {
			"type": "boolean",
			"required": true
		},
		"safeties_allowed": {
			"type": "number",
			"required": true
		},
		"stadium": {
			"key": true,
			"type": "string",
			"required": true
		},
		"temperature": {
			"type": "number",
			"required": true
		},
		"humidity": {
			"type": "number",
			"required": true
		},
		"wind_speed": {
			"type": "number",
			"required": true
		},
		"fan_duel_salary": {
			"type": "number",
			"required": false
		},
		"draft_kings_salary": {
			"type": "number",
			"required": false
		},
		"fantasy_data_salary": {
			"type": "number",
			"required": false
		},
		"offensive_snaps_played": {
			"type": "number",
			"required": true
		},
		"defensive_snaps_played": {
			"type": "number",
			"required": true
		},
		"special_teams_snaps_played": {
			"type": "number",
			"required": true
		},
		"offensive_team_snaps": {
			"type": "number",
			"required": true
		},
		"defensive_team_snaps": {
			"type": "number",
			"required": true
		},
		"special_teams_team_snaps": {
			"type": "number",
			"required": true
		},
		"victiv_salary": {
			"type": "undefined",
			"required": false
		},
		"two_point_conversion_returns": {
			"type": "number",
			"required": true
		},
		"fantasy_points_fan_duel": {
			"type": "number",
			"required": true
		},
		"field_goals_made0to19": {
			"type": "number",
			"required": true
		},
		"field_goals_made20to29": {
			"type": "number",
			"required": true
		},
		"field_goals_made30to39": {
			"type": "number",
			"required": true
		},
		"field_goals_made40to49": {
			"type": "number",
			"required": true
		},
		"field_goals_made50_plus": {
			"type": "number",
			"required": true
		},
		"fantasy_points_draft_kings": {
			"type": "number",
			"required": true
		},
		"yahoo_salary": {
			"type": "number",
			"required": false
		},
		"fantasy_points_yahoo": {
			"type": "number",
			"required": true
		},
		"injury_status": {
			"key": true,
			"type": "undefined",
			"required": false
		},
		"injury_body_part": {
			"type": "undefined",
			"required": false
		},
		"injury_start_date": {
			"type": "undefined",
			"required": false
		},
		"injury_notes": {
			"type": "undefined",
			"required": false
		},
		"fan_duel_position": {
			"type": "string",
			"required": false
		},
		"draft_kings_position": {
			"type": "string",
			"required": false
		},
		"yahoo_position": {
			"type": "string",
			"required": false
		},
		"opponent_rank": {
			"type": "number",
			"required": true
		},
		"opponent_position_rank": {
			"type": "number",
			"required": false
		},
		"injury_practice": {
			"type": "undefined",
			"required": false
		},
		"injury_practice_description": {
			"type": "undefined",
			"required": false
		},
		"declared_inactive": {
			"type": "boolean",
			"required": true
		},
		"fantasy_draft_salary": {
			"type": "number",
			"required": false
		},
		"fantasy_draft_position": {
			"type": "string",
			"required": false
		},
		"team_id": {
			"type": "number",
			"required": true
		},
		"opponent_id": {
			"type": "number",
			"required": true
		},
		"day": {
			"type": "string",
			"required": true
		},
		"date_time": {
			"type": "string",
			"required": true
		},
		"global_game_id": {
			"type": "number",
			"required": true
		},
		"global_team_id": {
			"type": "number",
			"required": true
		},
		"global_opponent_id": {
			"type": "number",
			"required": true
		},
		"score_id": {
			"type": "number",
			"required": true
		},
		"fantasy_points_fantasy_draft": {
			"type": "number",
			"required": true
		},
		"offensive_fumble_recovery_touchdowns": {
			"type": "undefined",
			"required": false
		}
	}
};

		drawERM(data);

		$("canvas").attr("width", $("svg").width());
		$("canvas").attr("height", $("svg").height());

		var st = $(document.createElement("style"));
		st.text("/* <![CDATA[ */" + $("style").text() + "/* ]]> */");
		$("svg").append(st);
		var html = d3.select("svg")
			.attr("version", 1.1)
			.attr("xmlns", "http://www.w3.org/2000/svg")
			.node().parentNode.innerHTML;

		var imgsrc = 'data:image/svg+xml;base64,'+ btoa(html);

		var canvas = document.querySelector("canvas"),
			context = canvas.getContext("2d");

		var image = new Image;
		image.src = imgsrc;
		image.onload = function() {
			context.drawImage(image, 0, 0);

			var canvasdata = canvas.toDataURL("image/png");

			var a = document.createElement("a");
			a.download = "diagram.png";
			a.href = canvasdata;
			document.body.appendChild(a);
			a.click();
		};
	</script>
</body>
